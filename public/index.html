<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <title>Formular zur Abizeitung</title>
</head>

<body class="bg-light">
    <div class="container">
        <main>
            <div class="py-5 text-center">
                <h2>Formular zur Abizeitung</h2>
                <p id="title-text">Auf dieser Seite sollen Textfelder ausgefüllt werden, um die für jeden Schüler benötigten Daten
                    sammeln zu können. Bitte bedenke, dass deine Antworten nicht zu lang sein sollten.</p>
            </div>
            <div class="container">
                <form class="needs-validation" autocomplete="off" novalidate>
                    <div class="row g-3">
                        <div class="col-sm-4">
                            <label for="vorname" class="form-label">Vorname</label>
                            <input type="text" class="form-control" id="vorname" placeholder="Vorname" required>
                            <div class="invalid-feedback">Bitte gib den Vornamen der Person ein.</div>
                        </div>
                        <div class="col-sm-4">
                            <label for="token" class="form-label">Token</label>
                            <input type="password" class="form-control" id="token" placeholder="Token" required>
                            <div class="invalid-feedback">Bitte gib den Authentifizierungs-Token der Person ein.</div>
                        </div>
                        <div class="col-sm-4">
                            <label for="geburtsdatum" class="form-label">Geburtsdatum</label>
                            <input type="date" class="form-control" id="geburtsdatum" placeholder="Geburtsdatum" required>
                            <div class="invalid-feedback">Bitte gib ein Geburtsdatum an.</div>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-analytics.js";
        import { signInAnonymously, getAuth } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.3/firebase-firestore.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAfYqX4XPmgJ3lWdzc66lAuGEHVWhjdr3s",
            authDomain: "gympeg-abizeitung.firebaseapp.com",
            projectId: "gympeg-abizeitung",
            storageBucket: "gympeg-abizeitung.appspot.com",
            messagingSenderId: "232535777638",
            appId: "1:232535777638:web:ad2eb5602fa8d3a89128a7",
            measurementId: "G-YM1XGVZFQY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const firestore = getFirestore(app);

        const formData = {
            'spitznamen': {
                'hint': 'Spitzname/n',
                'error': false,
            },
            'wohnort': {
                'hint': 'Wohnort',
                'error': true,
            },
            'plan': {
                'hint': 'Pläne nach dem Abi',
                'error': false,
            },
            'motto': {
                'hint': 'Lebensmotto',
                'error': false,
            },
            'lieblingsfach': {
                'hint': 'Lieblingsfach',
                'error': true,
            },
            'ohne-das': {
                'hint': 'Ohne das hätte ich die Schulzeit nicht überstanden',
                'error': true,
            },
            // insgeheime trennung
            'songtipp': {
                'hint': 'Mein geheimer Songtipp',
                'error': false,
            },
            'lieblingsgetraenke': {
                'hint': 'Lieblingsgetränke (anti-)alkoholisch',
                'error': false,
            },
            'gewinnen': {
                'hint': 'Dabei gewinne ich immer',
                'error': false,
            },
            'zu-oft': {
                'hint': 'Das sage ich zu oft',
                'error': false,
            },
            'langweiliges-buch': {
                'hint': 'Langweiligstes Buch aus der Schulzeit',
                'error': false,
            },
            'abwesenheitsgrund': {
                'hint': 'Häufigster Abwesenheitsgrund',
                'error': false,
            },
            'gelernt': {
                'hint': 'Das habe ich in meiner Schulzeit gelernt',
                'error': true,
            },
            'vermissen': {
                'hint': 'Das werde ich an der Schulzeit vermissen',
                'error': false,
            },
            'tipplehrer': {
                'hint': 'Mein Tipp an die Lehrer',
                'error': false,
            },
            'ratschlag-schueler': {
                'hint': 'Mein Ratschlag an die Schüler des Gympegs',
                'error': false,
            },
        };

        const loadForm = () => {
            const form = document.querySelector('form');
            for (const [id, data] of Object.entries(formData)) {
                const div = document.createElement('div');
                div.classList.add('col-12');

                const label = document.createElement('label');
                label.setAttribute('for', id);
                label.classList.add('form-label');
                label.innerText = data.hint;

                div.appendChild(label);

                const input = document.createElement('input');
                input.setAttribute('type', 'text');
                input.setAttribute('id', id);
                input.setAttribute('class', 'form-control');
                input.setAttribute('placeholder', data.hint);

                div.appendChild(input);

                if (data.error) {
                    input.setAttribute('required', 'true');

                    const error = document.createElement('div');
                    error.classList.add('invalid-feedback');
                    error.innerText = 'Bitte gib eine Antwort ein.';

                    div.appendChild(error);
                }

                form.children[0].appendChild(div);
            }

            const submitButton = document.createElement('button');
            submitButton.setAttribute('type', 'submit');
            submitButton.setAttribute('class', 'btn btn-primary');
            submitButton.innerText = 'Speichern';

            form.children[0].appendChild(submitButton);

            const padding = document.createElement('div');
            padding.style.height = '100px';
            form.children[0].appendChild(padding);

            form.addEventListener('submit', (event) => {
                event.preventDefault();
                event.stopPropagation();

                if (form.checkValidity()) {
                    const token = value('token');
                    const fields = Object.keys(formData);
                    fields.push('vorname');
                    fields.push('geburtsdatum');

                    const data = {};
                    fields.forEach((field) => { data[field] = value(field); })

                    sendData(token, data).then(() => {
                        form.innerHTML = '';
                        document.getElementById('title-text').innerText = 'Deine Daten wurden gespeichert.';
                    });
                }

                form.classList.add('was-validated');
            }, false);
        };

        const sendData = async (token, data) => {
            if (auth.currentUser === null) {
                await signInAnonymously(auth);
            }

            const entryDataCollection = collection(firestore, 'entrydata');
            const document = doc(entryDataCollection, token);
            await setDoc(document, data);
        };

        const value = (name) => {
            return document.getElementById(name).value;
        };

        window.onload = loadForm;
    </script>
</body>

</html>